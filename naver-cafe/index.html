<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XIVIX Tower Control â€” ë„¤ì´ë²„ ì¹´í˜ ìë™í™”</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/pretendard/1.3.9/static/pretendard.min.css" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a26;
  --border: #2a2a3a;
  --text: #e8e8f0;
  --text2: #8888a0;
  --accent: #00d4aa;
  --accent2: #00b894;
  --naver: #03c75a;
  --danger: #ff4757;
  --warning: #ffa502;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Pretendard', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.6;
}

/* â•â•â• Header â•â•â• */
.header {
  padding: 20px 32px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--surface);
}

.logo {
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

.logo span { color: var(--accent); }

.user-info {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  color: var(--text2);
}

.user-info .badge {
  background: var(--naver);
  color: #fff;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

/* â•â•â• Main Layout â•â•â• */
.main {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px;
}

/* â•â•â• Login Section â•â•â• */
.login-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  gap: 24px;
}

.login-section h1 {
  font-size: 32px;
  font-weight: 800;
  letter-spacing: -1px;
}

.login-section p {
  color: var(--text2);
  font-size: 16px;
  text-align: center;
  max-width: 400px;
}

.btn-naver {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--naver);
  color: #fff;
  border: none;
  padding: 14px 32px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-naver:hover { filter: brightness(1.1); transform: translateY(-1px); }

.btn-naver svg { width: 20px; height: 20px; }

/* â•â•â• Dashboard â•â•â• */
.dashboard { display: none; }
.dashboard.active { display: block; }

.grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

@media (max-width: 768px) {
  .grid-2 { grid-template-columns: 1fr; }
  .main { padding: 16px; }
}

/* â•â•â• Cards â•â•â• */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
}

.card-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text2);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-title .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
}

/* â•â•â• Form Elements â•â•â• */
label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--text2);
  margin-bottom: 6px;
}

input, select, textarea {
  width: 100%;
  padding: 10px 14px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: inherit;
  font-size: 14px;
  margin-bottom: 14px;
  transition: border-color 0.2s;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
}

textarea { resize: vertical; min-height: 120px; line-height: 1.7; }

/* â•â•â• Buttons â•â•â• */
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary {
  background: var(--accent);
  color: var(--bg);
}

.btn-primary:hover { filter: brightness(1.1); }

.btn-secondary {
  background: var(--surface2);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover { border-color: var(--accent); }

.btn-danger {
  background: var(--danger);
  color: #fff;
}

.btn-group {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

/* â•â•â• Queue List â•â•â• */
.queue-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--surface2);
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.queue-item:hover { border-left: 3px solid var(--accent); padding-left: 13px; }

.queue-item .cat {
  font-size: 12px;
  padding: 3px 8px;
  border-radius: 4px;
  font-weight: 600;
}

.cat-ì•”ë³´í—˜ { background: #ff475720; color: #ff6b81; }
.cat-ì¢…í•©ë³´í—˜ { background: #2563eb20; color: #60a5fa; }
.cat-íƒœì•„ë³´í—˜ { background: #f59e0b20; color: #fbbf24; }
.cat-ê°„ë³‘ë³´í—˜ { background: #8b5cf620; color: #a78bfa; }
.cat-ì‹¤ì†ë³´í—˜ { background: #10b98120; color: #34d399; }
.cat-ê¸°íƒ€ { background: #6b728020; color: #9ca3af; }

/* â•â•â• Preview â•â•â• */
.preview-box {
  background: #fff;
  color: #333;
  border-radius: 8px;
  padding: 24px;
  font-size: 15px;
  line-height: 2.2;
  max-height: 500px;
  overflow-y: auto;
}

.preview-box h1 { font-size: 20px; color: #1a1a1a; margin-bottom: 12px; }
.preview-box h2 { font-size: 17px; color: #2563eb; margin: 16px 0 8px; }
.preview-box h3 { font-size: 15px; color: #555; margin: 12px 0 6px; }
.preview-box hr { border: none; border-top: 1px solid #eee; margin: 16px 0; }

/* â•â•â• Status/Log â•â•â• */
.log-box {
  background: var(--surface2);
  border-radius: 8px;
  padding: 16px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  line-height: 1.8;
  max-height: 300px;
  overflow-y: auto;
  color: var(--text2);
}

.log-box .success { color: var(--accent); }
.log-box .error { color: var(--danger); }
.log-box .warn { color: var(--warning); }
.log-box .info { color: #60a5fa; }

/* â•â•â• Stats â•â•â• */
.stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

@media (max-width: 768px) {
  .stats { grid-template-columns: repeat(2, 1fr); }
}

.stat-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.stat-card .number {
  font-size: 28px;
  font-weight: 800;
  color: var(--accent);
}

.stat-card .label {
  font-size: 12px;
  color: var(--text2);
  margin-top: 4px;
}
</style>
</head>
<body>

<!-- â•â•â• Header â•â•â• -->
<div class="header">
  <div class="logo">XIVIX <span>Tower Control</span></div>
  <div class="user-info" id="userInfo" style="display:none">
    <span id="userName"></span>
    <span class="badge">ë„¤ì´ë²„ ì—°ê²°ë¨</span>
    <button class="btn btn-secondary" onclick="logout()" style="padding:6px 12px;font-size:12px">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</div>

<!-- â•â•â• Login Section â•â•â• -->
<div class="main">
  <div class="login-section" id="loginSection">
    <h1>ë„¤ì´ë²„ ì¹´í˜ <span style="color:var(--accent)">ìë™í™”</span></h1>
    <p>ë„¤ì´ë²„ ì•„ì´ë””ë¡œ ë¡œê·¸ì¸í•˜ë©´ ê°€ì…ëœ ì¹´í˜ì— ìë™ìœ¼ë¡œ ê¸€ì„ ë°œí–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <button class="btn-naver" onclick="naverLogin()">
      <svg viewBox="0 0 20 20" fill="currentColor"><path d="M13.5 10.5L6.2 0H0v20h6.5V9.5L13.8 20H20V0h-6.5z"/></svg>
      ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸
    </button>
    <p style="font-size:12px;color:var(--text2);margin-top:8px">
      * ì¹´í˜ ê¸€ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤ (ì¹´í˜ ê°€ì… + ë“±ì—… í•„ìˆ˜)
    </p>
  </div>

  <!-- â•â•â• Dashboard â•â•â• -->
  <div class="dashboard" id="dashboard">
    
    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <div class="number" id="statQueue">46</div>
        <div class="label">ë°œí–‰ ëŒ€ê¸°</div>
      </div>
      <div class="stat-card">
        <div class="number" id="statPublished">0</div>
        <div class="label">ë°œí–‰ ì™„ë£Œ</div>
      </div>
      <div class="stat-card">
        <div class="number" id="statCafes">-</div>
        <div class="label">ì—°ê²° ì¹´í˜</div>
      </div>
      <div class="stat-card">
        <div class="number" id="statTokenExp">-</div>
        <div class="label">í† í° ë§Œë£Œ</div>
      </div>
    </div>

    <div class="grid-2">

      <!-- ì¹´í˜ ì„¤ì • -->
      <div class="card">
        <div class="card-title"><div class="dot"></div> ì¹´í˜ ì„¤ì •</div>
        
        <label>ì¹´í˜ Club ID</label>
        <input type="text" id="clubId" placeholder="ì˜ˆ: 10347037 (ì¹´í˜ URLì—ì„œ í™•ì¸)" />
        
        <label>ê²Œì‹œíŒ Menu ID</label>
        <input type="text" id="menuId" placeholder="ì˜ˆ: 458 (ê²Œì‹œíŒ URLì—ì„œ í™•ì¸)" />
        
        <label>ê¸€ ê³µê°œ ì„¤ì •</label>
        <select id="openYn">
          <option value="true">ì „ì²´ ê³µê°œ</option>
          <option value="false">ë©¤ë²„ ê³µê°œ</option>
        </select>

        <p style="font-size:12px;color:var(--text2);line-height:1.6;margin-top:8px">
          ğŸ’¡ Club ID í™•ì¸: ì¹´í˜ URLì—ì„œ ìˆ«ì ë¶€ë¶„<br>
          ì˜ˆ: cafe.naver.com/ca-fe/cafes/<b>10347037</b>/articles<br>
          ğŸ’¡ Menu ID í™•ì¸: ê²Œì‹œíŒ URLì˜ menuid= ë’¤ ìˆ«ì
        </p>
      </div>

      <!-- ì½˜í…ì¸  ì‘ì„± -->
      <div class="card">
        <div class="card-title"><div class="dot"></div> ê¸€ ì‘ì„±</div>
        
        <label>ì œëª©</label>
        <input type="text" id="postSubject" placeholder="46ì„¸ ë‚¨í¸ ì•”ë³´í—˜ ë¦¬ëª¨ë¸ë§ ê³ ë¯¼ì¤‘ì…ë‹ˆë‹¤" />
        
        <label>ë³¸ë¬¸ (HTML ê°€ëŠ¥)</label>
        <textarea id="postContent" rows="8" placeholder="ì¹´í˜ ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="previewPost()">ë¯¸ë¦¬ë³´ê¸°</button>
          <button class="btn btn-primary" onclick="publishPost()">ğŸš€ ì¹´í˜ì— ë°œí–‰</button>
        </div>
      </div>
    </div>

    <div class="grid-2">

      <!-- ë°œí–‰ í -->
      <div class="card">
        <div class="card-title"><div class="dot"></div> ë°œí–‰ í (PDF ê¸°ë°˜)</div>
        <div id="queueList" style="max-height:400px;overflow-y:auto">
          <!-- ë™ì  ìƒì„± -->
        </div>
      </div>

      <!-- ë¡œê·¸ / ë¯¸ë¦¬ë³´ê¸° -->
      <div class="card">
        <div class="card-title"><div class="dot"></div> ì‹¤í–‰ ë¡œê·¸</div>
        <div class="log-box" id="logBox">
          <div class="info">â–¸ XIVIX Tower Control v3.0 ì¤€ë¹„ë¨</div>
          <div class="info">â–¸ ë„¤ì´ë²„ ì¹´í˜ API ì—°ê²° ëŒ€ê¸°ì¤‘...</div>
        </div>
      </div>
    </div>

    <!-- ë¯¸ë¦¬ë³´ê¸° -->
    <div class="card" id="previewCard" style="display:none;margin-top:20px">
      <div class="card-title"><div class="dot"></div> ë¯¸ë¦¬ë³´ê¸°</div>
      <div class="preview-box" id="previewBox"></div>
    </div>

  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// XIVIX Tower Control â€” ë„¤ì´ë²„ ì¹´í˜ API í´ë¼ì´ì–¸íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CONFIG = {
  NAVER_CLIENT_ID: 'DpPhbVPOWrfZdCtYeL5U',
  // Worker ë°°í¬ í›„ ë³€ê²½ í•„ìš”
  API_BASE: 'https://naver-cafe-api.ikjoobang.workers.dev',
  CALLBACK_URL: window.location.origin + '/callback',
};

// â•â•â• State â•â•â•
let state = {
  accessToken: localStorage.getItem('naver_access_token'),
  refreshToken: localStorage.getItem('naver_refresh_token'),
  userName: localStorage.getItem('naver_user_name'),
  publishedCount: parseInt(localStorage.getItem('published_count') || '0'),
};

// â•â•â• ë°œí–‰ í (PDF ë©”íƒ€ë°ì´í„°) â•â•â•
const PUBLISH_QUEUE = [
  { id: 1, title: '20ëŒ€ ì—¬ì ì¢…í•©ë³´í—˜ ë¹„ê°±ì‹ í˜• ì–´ë–¤ì§€ ë´ì£¼ì„¸ìš”', cat: 'ì¢…í•©ë³´í—˜', target: '20ëŒ€ ì—¬ì„±' },
  { id: 2, title: '30ëŒ€ 3ëŒ€ì§ˆë³‘ë³´í—˜ ë†í˜‘ì†í•´ ì œì¼ ì €ë ´í•œê°€ìš”', cat: 'ê¸°íƒ€', target: '30ëŒ€' },
  { id: 3, title: '30ëŒ€ ë‚¨ì ë¹„ê°±ì‹ í˜• ì¢…í•©ë³´í—˜ ë†í˜‘ì†í•´ ì§„ë‹¨ë¹„ ì„¤ê³„', cat: 'ì¢…í•©ë³´í—˜', target: '30ëŒ€ ë‚¨ì„±' },
  { id: 4, title: '30ëŒ€ ì—¬ì ì§ì¥ì¸ ì¢…í•©ë³´í—˜ ì›” 15ë§Œì›ëŒ€', cat: 'ì¢…í•©ë³´í—˜', target: '30ëŒ€ ì—¬ì„±' },
  { id: 5, title: '43ì„¸ ì—¬ì ë¹„ê°±ì‹ í˜• ì¢…í•©ë³´í—˜ ì–´ë–¤ì§€ ë´ì£¼ì„¸ìš”', cat: 'ì¢…í•©ë³´í—˜', target: '43ì„¸ ì—¬ì„±' },
  { id: 6, title: '50ëŒ€ ì—¬ì KBì•”ì£¼ìš”ì¹˜ë£Œë¹„ ë´ì£¼ì„¸ìš”', cat: 'ì•”ë³´í—˜', target: '50ëŒ€ ì—¬ì„±' },
  { id: 7, title: '5ì„¸ëŒ€ì‹¤ì† ì‹¤ë¹„ì „í™˜ ì¢…í•©ë³´í—˜ ë¦¬ëª¨ë¸ë§ 30ëŒ€ ì—¬ì', cat: 'ì‹¤ì†ë³´í—˜', target: '30ëŒ€ ì—¬ì„±' },
  { id: 8, title: '60ëŒ€ ë‚¨ì ì•”ì§„ë‹¨ê¸ˆ ë¹„ê¸‰ì—¬ì•”ì¹˜ë£Œë¹„ ìœ ë³‘ì ì•”ë³´í—˜', cat: 'ì•”ë³´í—˜', target: '60ëŒ€ ë‚¨ì„±' },
  { id: 9, title: '70ëŒ€ í›„ë°˜ ì—¬ì ì‹¤ì†ë³´í—˜ ìœ ë³‘ì ì‹¤ì† 7ë§Œì›', cat: 'ì‹¤ì†ë³´í—˜', target: '70ëŒ€ ì—¬ì„±' },
  { id: 10, title: 'KBìƒëª… ì ê¸ˆë³´í—˜ ì ê¸ˆ ëŒ€ì‹  ê°€ì… ì–´ë–¨ê¹Œìš”', cat: 'ê¸°íƒ€', target: '30ëŒ€' },
  { id: 11, title: 'ê°„ë³‘ë³´í—˜', cat: 'ê°„ë³‘ë³´í—˜', target: '30ëŒ€' },
  { id: 12, title: 'ê°„ë³‘ì¸ë³´í—˜ ìš”ì–‘ë³‘ì› ì œì™¸ 20ë§Œì› í¥êµ­', cat: 'ê°„ë³‘ë³´í—˜', target: '30ëŒ€' },
  { id: 13, title: 'êµë³´ìƒëª… ê³ í˜ˆì••ë³´í—˜ ë‹¹ë‡¨ë³´í—˜ 500ë§Œì›', cat: 'ê¸°íƒ€', target: '30ëŒ€' },
  { id: 14, title: 'ë‹¤ë“¤ ì•”ì§„ë‹¨ë¹„ ì–¼ë§ˆì”© í•´ë‘ì…¨ì–´ìš” 5ì²œì´ë©´ ì¶©ë¶„?', cat: 'ì•”ë³´í—˜', target: '30ëŒ€' },
  { id: 15, title: 'ë©”ë¦¬ì¸  ì•”í†µí•©ì¹˜ë£Œë¹„ê°€ ì•”ì£¼ìš”ì¹˜ë£Œë¹„ë³´ë‹¤ ì¢‹ë‚˜ìš”', cat: 'ì•”ë³´í—˜', target: '30ëŒ€' },
  { id: 16, title: 'ì‚¼ì„±í™”ì¬ ì•”í†µí•©ì¹˜ë£Œë¹„ë³´í—˜ ì–´ë–¤ì§€ ë´ì£¼ì„¸ìš”', cat: 'ì•”ë³´í—˜', target: '30ëŒ€' },
  { id: 17, title: 'ì‚¬ë§ë³´í—˜ 1ì–µì´ë©´ ì¶©ë¶„í• ê¹Œìš” 40ì„¸ ì—¬ì', cat: 'ì•”ë³´í—˜', target: '40ì„¸ ì—¬ì„±' },
  { id: 18, title: 'íƒœì•„ë³´í—˜ ë¦¬ëª¨ë¸ë§ ì¢…í•©ë³´í—˜ ìë…€ ê°€ì… ê³ ë¯¼', cat: 'íƒœì•„ë³´í—˜', target: '30ëŒ€' },
  { id: 19, title: 'í˜„ëŒ€í•´ìƒ íƒœì•„ë³´í—˜ ì‚°ëª¨íŠ¹ì•½ êµ¬ì„±ë¬¸ì˜', cat: 'íƒœì•„ë³´í—˜', target: '30ëŒ€ ì—¬ì„±' },
  { id: 20, title: 'í¥êµ­ìƒëª… ë‹¤ë¹ˆì¹˜ë¡œë´‡ì•”ìˆ˜ìˆ ë³´í—˜ ë´ì£¼ì„¸ìš”', cat: 'ì•”ë³´í—˜', target: '30ëŒ€' },
];


// â•â•â• ì´ˆê¸°í™” â•â•â•
function init() {
  // OAuth ì½œë°± ì²˜ë¦¬
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  const authState = urlParams.get('state');
  
  if (code) {
    handleOAuthCallback(code, authState);
    return;
  }

  if (state.accessToken) {
    showDashboard();
  }
  
  renderQueue();
}

// â•â•â• ë„¤ì´ë²„ ë¡œê·¸ì¸ â•â•â•
function naverLogin() {
  const authState = Math.random().toString(36).substring(2, 10);
  const authUrl = 'https://nid.naver.com/oauth2.0/authorize'
    + `?response_type=code`
    + `&client_id=${CONFIG.NAVER_CLIENT_ID}`
    + `&redirect_uri=${encodeURIComponent(window.location.origin + window.location.pathname)}`
    + `&state=${authState}`;
  
  localStorage.setItem('oauth_state', authState);
  window.location.href = authUrl;
}

// â•â•â• OAuth ì½œë°± ì²˜ë¦¬ â•â•â•
async function handleOAuthCallback(code, authState) {
  addLog('info', 'ë„¤ì´ë²„ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘...');
  
  try {
    const redirectUri = window.location.origin + window.location.pathname;
    const res = await fetch(
      `${CONFIG.API_BASE}/auth/callback?code=${code}&state=${authState}&redirect_uri=${encodeURIComponent(redirectUri)}`
    );
    const data = await res.json();
    
    if (data.error) {
      addLog('error', `ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.error} â€” ${data.description || ''}`);
      return;
    }
    
    state.accessToken = data.access_token;
    state.refreshToken = data.refresh_token;
    
    localStorage.setItem('naver_access_token', data.access_token);
    localStorage.setItem('naver_refresh_token', data.refresh_token || '');
    
    // URL ì •ë¦¬ (code íŒŒë¼ë¯¸í„° ì œê±°)
    window.history.replaceState({}, '', window.location.pathname);
    
    addLog('success', 'âœ… ë„¤ì´ë²„ ë¡œê·¸ì¸ ì„±ê³µ!');
    
    // í”„ë¡œí•„ ì¡°íšŒ
    await fetchProfile();
    
    showDashboard();
    
  } catch (err) {
    addLog('error', `ë¡œê·¸ì¸ ì—ëŸ¬: ${err.message}`);
  }
}

// â•â•â• í”„ë¡œí•„ ì¡°íšŒ â•â•â•
async function fetchProfile() {
  try {
    const res = await fetch(`${CONFIG.API_BASE}/auth/profile`, {
      headers: { 'Authorization': `Bearer ${state.accessToken}` },
    });
    const data = await res.json();
    
    if (data.response) {
      state.userName = data.response.nickname || data.response.name || 'ì‚¬ìš©ì';
      localStorage.setItem('naver_user_name', state.userName);
      addLog('success', `í”„ë¡œí•„: ${state.userName}`);
    }
  } catch (err) {
    addLog('warn', 'í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨ (í† í°ì€ ìœ íš¨)');
  }
}

// â•â•â• ëŒ€ì‹œë³´ë“œ í‘œì‹œ â•â•â•
function showDashboard() {
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('dashboard').classList.add('active');
  document.getElementById('userInfo').style.display = 'flex';
  document.getElementById('userName').textContent = state.userName || 'ì—°ê²°ë¨';
  
  // í†µê³„ ì—…ë°ì´íŠ¸
  document.getElementById('statPublished').textContent = state.publishedCount;
  document.getElementById('statTokenExp').textContent = 'ìœ íš¨';
  
  addLog('info', 'â–¸ ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ');
  addLog('info', `â–¸ ë°œí–‰ í: ${PUBLISH_QUEUE.length}ê°œ`);
}

// â•â•â• ë¡œê·¸ì•„ì›ƒ â•â•â•
function logout() {
  localStorage.removeItem('naver_access_token');
  localStorage.removeItem('naver_refresh_token');
  localStorage.removeItem('naver_user_name');
  state.accessToken = null;
  state.refreshToken = null;
  state.userName = null;
  
  document.getElementById('loginSection').style.display = 'flex';
  document.getElementById('dashboard').classList.remove('active');
  document.getElementById('userInfo').style.display = 'none';
}

// â•â•â• ë°œí–‰ í ë Œë”ë§ â•â•â•
function renderQueue() {
  const container = document.getElementById('queueList');
  if (!container) return;
  
  container.innerHTML = PUBLISH_QUEUE.map(item => {
    const catClass = `cat-${item.cat}`;
    return `
      <div class="queue-item" onclick="selectQueueItem(${item.id})">
        <div>
          <span class="cat ${catClass}">${item.cat}</span>
          <span style="margin-left:8px;font-size:13px">${item.title.substring(0, 40)}${item.title.length > 40 ? '...' : ''}</span>
        </div>
        <span style="font-size:12px;color:var(--text2)">${item.target}</span>
      </div>
    `;
  }).join('');
}

// â•â•â• í í•­ëª© ì„ íƒ â†’ ì œëª©/ë³¸ë¬¸ ìë™ ì±„ì›€ â•â•â•
function selectQueueItem(id) {
  const item = PUBLISH_QUEUE.find(q => q.id === id);
  if (!item) return;
  
  document.getElementById('postSubject').value = item.title;
  
  // ê¸°ë³¸ ë³¸ë¬¸ í…œí”Œë¦¿ ìƒì„±
  const content = generateCafeContent(item);
  document.getElementById('postContent').value = content;
  
  addLog('info', `â–¸ #${id} ì„ íƒ: ${item.title.substring(0, 30)}...`);
}

// â•â•â• ì¹´í˜ ì½˜í…ì¸  ìƒì„± (ê¸°ë³¸ í…œí”Œë¦¿) â•â•â•
function generateCafeContent(item) {
  return `ì•ˆë…•í•˜ì„¸ìš”, ${item.target} ${item.cat} ê´€ë ¨í•´ì„œ ì§ˆë¬¸ë“œë¦½ë‹ˆë‹¤.

${item.title}

ìš”ì¦˜ ë³´í—˜ ë¦¬ëª¨ë¸ë§ ê´€ë ¨í•´ì„œ ë§ì´ ì•Œì•„ë³´ê³  ìˆëŠ”ë°, 
í˜¹ì‹œ ë¹„ìŠ·í•œ ê²½í—˜ ìˆìœ¼ì‹  ë¶„ë“¤ ì¡°ì–¸ ì¢€ ë¶€íƒë“œë ¤ìš”!

ì œê°€ ì›í•˜ëŠ” ê±´:
- ë³´í—˜ë£Œ ëŒ€ë¹„ ë³´ì¥ ë²”ìœ„ê°€ ë„“ì€ êµ¬ì„±
- ê°±ì‹ í˜•ë³´ë‹¤ ë¹„ê°±ì‹ í˜• ì„ í˜¸
- ì›” ë³´í—˜ë£Œ í•©ë¦¬ì ì¸ ì„ ì—ì„œ

ê²½í—˜ë‹´ì´ë‚˜ ì¡°ì–¸ ê°ì‚¬í•©ë‹ˆë‹¤ :)

#${item.cat} #ë³´í—˜ë¹„êµ #ë³´í—˜ìƒë‹´ #${item.target.replace(' ', '')}`;
}

// â•â•â• ë¯¸ë¦¬ë³´ê¸° â•â•â•
function previewPost() {
  const subject = document.getElementById('postSubject').value;
  const content = document.getElementById('postContent').value;
  
  if (!subject || !content) {
    addLog('warn', 'ì œëª©ê³¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  const previewCard = document.getElementById('previewCard');
  const previewBox = document.getElementById('previewBox');
  
  previewBox.innerHTML = `<h1>${subject}</h1><hr>${content.replace(/\n/g, '<br>')}`;
  previewCard.style.display = 'block';
  previewCard.scrollIntoView({ behavior: 'smooth' });
}

// â•â•â• ì¹´í˜ ë°œí–‰ â•â•â•
async function publishPost() {
  const clubId = document.getElementById('clubId').value.trim();
  const menuId = document.getElementById('menuId').value.trim();
  const subject = document.getElementById('postSubject').value.trim();
  const content = document.getElementById('postContent').value.trim();
  const openYn = document.getElementById('openYn').value;
  
  if (!clubId || !menuId) {
    addLog('error', 'ì¹´í˜ Club IDì™€ Menu IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  if (!subject || !content) {
    addLog('error', 'ì œëª©ê³¼ ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”');
    return;
  }
  
  if (!state.accessToken) {
    addLog('error', 'ë„¤ì´ë²„ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
    return;
  }
  
  addLog('info', `â–¸ ë°œí–‰ ì¤‘... [${clubId}/${menuId}]`);
  
  try {
    const res = await fetch(`${CONFIG.API_BASE}/cafe/write`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${state.accessToken}`,
      },
      body: JSON.stringify({
        clubid: clubId,
        menuid: menuId,
        subject: subject,
        content: content,
        openyn: openYn === 'true',
      }),
    });
    
    const data = await res.json();
    
    if (res.ok && !data.error) {
      state.publishedCount++;
      localStorage.setItem('published_count', state.publishedCount.toString());
      document.getElementById('statPublished').textContent = state.publishedCount;
      
      addLog('success', `âœ… ë°œí–‰ ì„±ê³µ! Article ID: ${data.articleId || JSON.stringify(data)}`);
      
      // ë‹¤ìŒ ì¹´í˜ URL í‘œì‹œ
      const cafeUrl = `https://cafe.naver.com/ca-fe/cafes/${clubId}/articles/${data.articleId || ''}`;
      addLog('success', `ğŸ“ ${cafeUrl}`);
    } else {
      addLog('error', `ë°œí–‰ ì‹¤íŒ¨: ${data.error_description || data.message || JSON.stringify(data)}`);
      
      if (res.status === 401) {
        addLog('warn', 'í† í° ë§Œë£Œ. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.');
      }
    }
  } catch (err) {
    addLog('error', `ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ${err.message}`);
  }
}

// â•â•â• ë¡œê·¸ â•â•â•
function addLog(type, message) {
  const logBox = document.getElementById('logBox');
  if (!logBox) return;
  
  const time = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const div = document.createElement('div');
  div.className = type;
  div.textContent = `[${time}] ${message}`;
  logBox.appendChild(div);
  logBox.scrollTop = logBox.scrollHeight;
}

// â•â•â• ì´ˆê¸°í™” ì‹¤í–‰ â•â•â•
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
